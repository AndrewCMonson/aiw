name: AIW Self-Review Check (Pilot)

on:
  pull_request:

jobs:
  aiw-self-review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify AIW self-review receipt exists for this PR
        shell: bash
        run: |
          set -euo pipefail

          PR_HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          PR_BASE_SHA="${{ github.event.pull_request.base.sha }}"

          echo "PR BASE SHA: $PR_BASE_SHA"
          echo "PR HEAD SHA: $PR_HEAD_SHA"

          RANGE="${PR_BASE_SHA}..${PR_HEAD_SHA}"
          RECEIPT_DIR=".aiw/receipts/pre_push_review"

          # Pilot escape hatch (explicit intent)
          if git log --format=%B "$RANGE" | grep -q "\[aiw-skip\]"; then
            {
              echo "## ⚠️ AIW Self-Review Skipped via \`[aiw-skip]\` (Pilot)"
              echo ""
              echo "- PR HEAD: \`$PR_HEAD_SHA\`"
              echo "- This is allowed during the pilot. Consider removing skip once stable."
            } >> "$GITHUB_STEP_SUMMARY"

            echo "::warning title=AIW Self-Review Skipped::PR includes [aiw-skip]. Self-review was intentionally skipped (pilot mode)."
            exit 0
          fi

          # Gather SHAs in this PR (inclusive of head)
          mapfile -t SHAS < <(git rev-list "$RANGE")
          # Ensure head is included (rev-list should include it, but be safe)
          SHAS+=("$PR_HEAD_SHA")

          if [ ! -d "$RECEIPT_DIR" ]; then
            {
              echo "## ⚠️ AIW Self-Review Missing (Pilot)"
              echo ""
              echo "- Missing receipt directory: \`$RECEIPT_DIR\`"
              echo "- PR HEAD: \`$PR_HEAD_SHA\`"
              echo ""
              echo "**How to comply**"
