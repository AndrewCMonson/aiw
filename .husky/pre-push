#!/usr/bin/env sh

# Save stdin for the context check (git passes ref info here)
INPUT=$(cat)

# Skip validation for merge commits
if git log -1 --pretty=%B | grep -q "^Merge"; then
  exit 0
fi

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Allow protected branches (main, master, develop) to bypass branch name validation
IS_PROTECTED=0
if echo "$BRANCH" | grep -qE "^(main|master|develop)$"; then
  IS_PROTECTED=1
fi

# Validate branch naming convention for non-protected branches
if [ "$IS_PROTECTED" -eq 0 ]; then
  if ! echo "$BRANCH" | grep -qE "^feature/[A-Z]+-[0-9]+(-[a-zA-Z0-9-]+)?$"; then
    echo "Error: Branch name must follow pattern: feature/ABC-123 or feature/ABC-123-Description"
    echo "Current branch: $BRANCH"
    exit 1
  fi
fi

# Run full linting before push
npm run lint || exit $?

# Run context verification (pass saved stdin)
# Temporarily disabled - uncomment to re-enable
# echo "$INPUT" | ./scripts/pre-push-context-check.sh || exit $?

# ---------------------------------------
# AIW Pre-Push Review Gate (soft + visible)
# ---------------------------------------

# Determine current HEAD SHA (used to verify freshness)
HEAD_SHA=$(git rev-parse HEAD 2>/dev/null)
if [ -z "$HEAD_SHA" ]; then
  echo "⚠️  Unable to determine HEAD SHA. Skipping AIW pre-push review gate."
  exit 0
fi

RECEIPT_DIR=".aiw/receipts/pre_push_review"
RECEIPT_FILE="${RECEIPT_DIR}/${HEAD_SHA}.md"

# Helper: does a receipt exist for this HEAD?
has_receipt_for_head() {
  [ -f "$RECEIPT_FILE" ]
}

# Helper: detect intentional skip via last commit message
has_aiw_skip_commit() {
  git log -1 --pretty=%B | grep -q "\[aiw-skip\]"
}

# Helper: find newest review artifact that references HEAD_SHA (preferred)
find_most_recent_artifact() {
  local reviews_dir=".ai/context/pr_reviews"

  if [ ! -d "$reviews_dir" ]; then
    echo ""
    return
  fi

  # Prefer the newest artifact that references HEAD_SHA (prevents false receipts)
  local newest=""
  newest=$(ls -t "$reviews_dir"/*.md 2>/dev/null | head -50 | while read -r f; do
    if grep -q "$HEAD_SHA" "$f" 2>/dev/null; then
      echo "$f"
      break
    fi
  done)

  # Fallback: newest file (if sha-based detection fails)
  if [ -z "$newest" ]; then
    newest=$(ls -t "$reviews_dir"/*.md 2>/dev/null | head -1)
  fi

  echo "$newest"
}

# Helper: extract risk level from artifact (optional)
extract_risk_level() {
  local artifact_path="$1"

  if [ -z "$artifact_path" ] || [ ! -f "$artifact_path" ]; then
    echo "(not found)"
    return
  fi

  # Try a few common patterns; if none match, return (not found)
  # This is intentionally forgiving to avoid coupling to exact phrasing.
  local line=""
  line=$(grep -iE "(^|\b)risk(\b|[^a-z])" "$artifact_path" 2>/dev/null | head -1)

  # If we found something, normalize to low/medium/high if possible
  case "$(echo "$line" | tr '[:upper:]' '[:lower:]')" in
    *low*) echo "low" ;;
    *med*|*medium*) echo "medium" ;;
    *high*) echo "high" ;;
    *) echo "(not found)" ;;
  esac
}

# Helper: create receipt file for current HEAD
create_receipt_for_head() {
  local timestamp
  timestamp=$(date '+%Y-%m-%d %H:%M:%S')

  local artifact_path
  artifact_path=$(find_most_recent_artifact)

  local risk_level
  risk_level=$(extract_risk_level "$artifact_path")

  mkdir -p "$RECEIPT_DIR"

  local artifact_display="$artifact_path"
  if [ -z "$artifact_display" ]; then
    artifact_display="(not found)"
  fi

  cat > "$RECEIPT_FILE" <<EOF
# AIW Pre-Push Review Receipt

- Head SHA: ${HEAD_SHA}
- Branch: ${BRANCH}
- Generated: ${timestamp}
- Local artifact: ${artifact_display}
- Risk: ${risk_level}
EOF

  echo "$RECEIPT_FILE"
}

# If receipt already exists, continue silently
if has_receipt_for_head; then
  echo "✅ AIW pre-push review receipt found for HEAD ($HEAD_SHA)."
  exit 0
fi

# If commit explicitly declares skip, allow but warn
if has_aiw_skip_commit; then
  echo "⚠️  AIW pre-push review intentionally skipped via [aiw-skip]."
  echo "    This will be visible in CI for this PR."
  exit 0
fi

# If explicit env var bypass is set, allow but warn
if [ -n "$AIW_SKIP" ]; then
  echo "⚠️  AIW pre-push review bypassed via AIW_SKIP=$AIW_SKIP."
  echo "    Prefer using [aiw-skip] in commit messages for auditability."
  echo "    CI will flag this as missing unless [aiw-skip] is present."
  exit 0
fi

# If aiw isn't installed, warn but don't block
if ! command -v aiw >/dev/null 2>&1; then
  echo "⚠️  aiw command not found. Skipping AIW pre-push review gate."
  echo "    Install AIW to enable self-review enforcement."
  exit 0
fi

echo ""
echo "❌ AIW pre-push self-review receipt is missing for current HEAD:"
echo "    $HEAD_SHA"
echo ""
echo "To comply, run the review and commit the receipt:"
echo ""
echo "    aiw run pre_push_review -i"
echo "    git add .aiw/receipts/"
echo "    git commit --amend --no-edit"
echo "    git push"
echo ""
echo "To intentionally skip (visible in CI):"
echo "    git commit --amend -m \"Your message [aiw-skip]\""
echo "    git push"
echo ""
exit 1
