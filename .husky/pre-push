#!/usr/bin/env sh

# Save stdin for the context check (git passes ref info here)
INPUT=$(cat)

# Skip validation for merge commits
if git log -1 --pretty=%B | grep -q "^Merge"; then
    exit 0
fi

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Allow protected branches (main, master, develop) to bypass branch name validation
if echo "$BRANCH" | grep -qE "^(main|master|develop)$"; then
    # Run full linting before push
    npm run lint
    # Run context verification (pass saved stdin)
    echo "$INPUT" | ./scripts/pre-push-context-check.sh
    exit $?
fi

# Validate branch naming convention: feature/ABC-123 or feature/ABC-123-Description
if ! echo "$BRANCH" | grep -qE "^feature/[A-Z]+-[0-9]+(-[a-zA-Z0-9-]+)?$"; then
    echo "Error: Branch name must follow pattern: feature/ABC-123 or feature/ABC-123-Description"
    echo "Current branch: $BRANCH"
    exit 1
fi

# Run full linting before push
npm run lint

# Run context verification for feature branches too
echo "$INPUT" | ./scripts/pre-push-context-check.sh
